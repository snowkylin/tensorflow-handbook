

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="zh-CN" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="zh-CN" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>TensorFlow模型部署 &mdash; 简单粗暴TensorFlow 0.4 alpha 文档</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/custom.css" type="text/css" />
    <link rel="index" title="索引" href="../genindex.html" />
    <link rel="search" title="搜索" href="../search.html" />
    <link rel="next" title="TensorFlow大规模训练" href="training.html" />
    <link rel="prev" title="TensorFlow持久化与可视化" href="extended.html" /> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> 简单粗暴TensorFlow
          

          
          </a>

          
            
            
              <div class="version">
                0.4
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">目录</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="preface.html">前言</a></li>
<li class="toctree-l1"><a class="reference internal" href="introduction.html">TensorFlow概述</a></li>
<li class="toctree-l1"><a class="reference internal" href="installation.html">TensorFlow安装</a></li>
<li class="toctree-l1"><a class="reference internal" href="basic.html">TensorFlow基础</a></li>
<li class="toctree-l1"><a class="reference internal" href="models.html">TensorFlow模型</a></li>
<li class="toctree-l1"><a class="reference internal" href="extended.html">TensorFlow持久化与可视化</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">TensorFlow模型部署</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#savedmodel">模型的导出：SavedModel</a></li>
<li class="toctree-l2"><a class="reference internal" href="#keras-sequential-save">模型的导出：Keras Sequential save方法</a></li>
<li class="toctree-l2"><a class="reference internal" href="#tensorflow-serving">服务器部署模型：TensorFlow Serving</a></li>
<li class="toctree-l2"><a class="reference internal" href="#tensorflow-lite">移动/嵌入式端部署模型：TensorFlow Lite</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id1">模型转换</a></li>
<li class="toctree-l3"><a class="reference internal" href="#android">Android部署</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#tensorflow-js">网页端部署模型：TensorFlow.js</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="training.html">TensorFlow大规模训练</a></li>
<li class="toctree-l1"><a class="reference internal" href="static.html">附录1：静态的TensorFlow</a></li>
<li class="toctree-l1"><a class="reference internal" href="swift.html">附录2：TensorFlow for Swift</a></li>
<li class="toctree-l1"><a class="reference internal" href="reuse.html">附录3：TensorFlow预训练模型</a></li>
<li class="toctree-l1"><a class="reference internal" href="probability.html">附录4：TensorFlow Probability</a></li>
<li class="toctree-l1"><a class="reference internal" href="custom_op.html">附录5：TensorFlow自定义运算操作</a></li>
<li class="toctree-l1"><a class="reference internal" href="config.html">附录6：TensorFlow环境配置与管理</a></li>
<li class="toctree-l1"><a class="reference internal" href="recommended_books.html">附录7：参考资料与推荐阅读</a></li>
</ul>
<p class="caption"><span class="caption-text">Contents</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../en/preface.html">Preface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../en/installation.html">TensorFlow Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../en/basic.html">TensorFlow Basic</a></li>
<li class="toctree-l1"><a class="reference internal" href="../en/models.html">TensorFlow Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../en/extended.html">TensorFlow Extensions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../en/static.html">Appendix: Static TensorFlow</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">简单粗暴TensorFlow</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
      <li>TensorFlow模型部署</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/zh/deployment.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="tensorflow">
<h1>TensorFlow模型部署<a class="headerlink" href="#tensorflow" title="永久链接至标题">¶</a></h1>
<div class="section" id="savedmodel">
<h2>模型的导出：SavedModel<a class="headerlink" href="#savedmodel" title="永久链接至标题">¶</a></h2>
<p>TODO: 2.0 eager + Keras Sequential save model way</p>
</div>
<div class="section" id="keras-sequential-save">
<h2>模型的导出：Keras Sequential save方法<a class="headerlink" href="#keras-sequential-save" title="永久链接至标题">¶</a></h2>
<p>我们以keras模型训练和保存为例进行讲解，如下是keras官方的mnist模型训练样例。</p>
<p>源码地址:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">keras</span><span class="o">-</span><span class="n">team</span><span class="o">/</span><span class="n">keras</span><span class="o">/</span><span class="n">blob</span><span class="o">/</span><span class="n">master</span><span class="o">/</span><span class="n">examples</span><span class="o">/</span><span class="n">mnist_cnn</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
<p>具体如下:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">COPYRIGHT</span>

<span class="n">All</span> <span class="n">contributions</span> <span class="n">by</span> <span class="n">François</span> <span class="n">Chollet</span><span class="p">:</span>
<span class="n">Copyright</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="mi">2015</span> <span class="o">-</span> <span class="mi">2018</span><span class="p">,</span> <span class="n">François</span> <span class="n">Chollet</span><span class="o">.</span>
<span class="n">All</span> <span class="n">rights</span> <span class="n">reserved</span><span class="o">.</span>

<span class="n">All</span> <span class="n">contributions</span> <span class="n">by</span> <span class="n">Google</span><span class="p">:</span>
<span class="n">Copyright</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="mi">2015</span> <span class="o">-</span> <span class="mi">2018</span><span class="p">,</span> <span class="n">Google</span><span class="p">,</span> <span class="n">Inc</span><span class="o">.</span>
<span class="n">All</span> <span class="n">rights</span> <span class="n">reserved</span><span class="o">.</span>

<span class="n">All</span> <span class="n">contributions</span> <span class="n">by</span> <span class="n">Microsoft</span><span class="p">:</span>
<span class="n">Copyright</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="mi">2017</span> <span class="o">-</span> <span class="mi">2018</span><span class="p">,</span> <span class="n">Microsoft</span><span class="p">,</span> <span class="n">Inc</span><span class="o">.</span>
<span class="n">All</span> <span class="n">rights</span> <span class="n">reserved</span><span class="o">.</span>

<span class="n">All</span> <span class="n">other</span> <span class="n">contributions</span><span class="p">:</span>
<span class="n">Copyright</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="mi">2015</span> <span class="o">-</span> <span class="mi">2018</span><span class="p">,</span> <span class="n">the</span> <span class="n">respective</span> <span class="n">contributors</span><span class="o">.</span>
<span class="n">All</span> <span class="n">rights</span> <span class="n">reserved</span><span class="o">.</span>

<span class="n">Each</span> <span class="n">contributor</span> <span class="n">holds</span> <span class="n">copyright</span> <span class="n">over</span> <span class="n">their</span> <span class="n">respective</span> <span class="n">contributions</span><span class="o">.</span>
<span class="n">The</span> <span class="n">project</span> <span class="n">versioning</span> <span class="p">(</span><span class="n">Git</span><span class="p">)</span> <span class="n">records</span> <span class="nb">all</span> <span class="n">such</span> <span class="n">contribution</span> <span class="n">source</span> <span class="n">information</span><span class="o">.</span>

<span class="n">LICENSE</span>

<span class="n">The</span> <span class="n">MIT</span> <span class="n">License</span> <span class="p">(</span><span class="n">MIT</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="sd">&#39;&#39;&#39;Trains a simple convnet on the MNIST dataset.</span>

<span class="sd">Gets to 99.25% test accuracy after 12 epochs</span>
<span class="sd">(there is still a lot of margin for parameter tuning).</span>
<span class="sd">16 seconds per epoch on a GRID K520 GPU.</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span>
<span class="kn">import</span> <span class="nn">keras</span>
<span class="kn">from</span> <span class="nn">keras.datasets</span> <span class="k">import</span> <span class="n">mnist</span>
<span class="kn">from</span> <span class="nn">keras.models</span> <span class="k">import</span> <span class="n">Sequential</span>
<span class="kn">from</span> <span class="nn">keras.layers</span> <span class="k">import</span> <span class="n">Dense</span><span class="p">,</span> <span class="n">Dropout</span><span class="p">,</span> <span class="n">Flatten</span>
<span class="kn">from</span> <span class="nn">keras.layers</span> <span class="k">import</span> <span class="n">Conv2D</span><span class="p">,</span> <span class="n">MaxPooling2D</span>
<span class="kn">from</span> <span class="nn">keras</span> <span class="k">import</span> <span class="n">backend</span> <span class="k">as</span> <span class="n">K</span>

<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">128</span>
<span class="n">num_classes</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">epochs</span> <span class="o">=</span> <span class="mi">12</span>

<span class="c1"># input image dimensions</span>
<span class="n">img_rows</span><span class="p">,</span> <span class="n">img_cols</span> <span class="o">=</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span>

<span class="c1"># the data, split between train and test sets</span>
<span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">),</span> <span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span> <span class="o">=</span> <span class="n">mnist</span><span class="o">.</span><span class="n">load_data</span><span class="p">()</span>

<span class="k">if</span> <span class="n">K</span><span class="o">.</span><span class="n">image_data_format</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;channels_first&#39;</span><span class="p">:</span>
    <span class="n">x_train</span> <span class="o">=</span> <span class="n">x_train</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">img_rows</span><span class="p">,</span> <span class="n">img_cols</span><span class="p">)</span>
    <span class="n">x_test</span> <span class="o">=</span> <span class="n">x_test</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x_test</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">img_rows</span><span class="p">,</span> <span class="n">img_cols</span><span class="p">)</span>
    <span class="n">input_shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">img_rows</span><span class="p">,</span> <span class="n">img_cols</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">x_train</span> <span class="o">=</span> <span class="n">x_train</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">img_rows</span><span class="p">,</span> <span class="n">img_cols</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">x_test</span> <span class="o">=</span> <span class="n">x_test</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x_test</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">img_rows</span><span class="p">,</span> <span class="n">img_cols</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">input_shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">img_rows</span><span class="p">,</span> <span class="n">img_cols</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">x_train</span> <span class="o">=</span> <span class="n">x_train</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
<span class="n">x_test</span> <span class="o">=</span> <span class="n">x_test</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
<span class="n">x_train</span> <span class="o">/=</span> <span class="mi">255</span>
<span class="n">x_test</span> <span class="o">/=</span> <span class="mi">255</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;x_train shape:&#39;</span><span class="p">,</span> <span class="n">x_train</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">x_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;train samples&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">x_test</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;test samples&#39;</span><span class="p">)</span>

<span class="c1"># convert class vectors to binary class matrices</span>
<span class="n">y_train</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">to_categorical</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">)</span>
<span class="n">y_test</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">to_categorical</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">)</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">Sequential</span><span class="p">()</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
                 <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">,</span>
                 <span class="n">input_shape</span><span class="o">=</span><span class="n">input_shape</span><span class="p">))</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">MaxPooling2D</span><span class="p">(</span><span class="n">pool_size</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.25</span><span class="p">))</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Flatten</span><span class="p">())</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dense</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.5</span><span class="p">))</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dense</span><span class="p">(</span><span class="n">num_classes</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;softmax&#39;</span><span class="p">))</span>

<span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="n">keras</span><span class="o">.</span><span class="n">losses</span><span class="o">.</span><span class="n">categorical_crossentropy</span><span class="p">,</span>
              <span class="n">optimizer</span><span class="o">=</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adadelta</span><span class="p">(),</span>
              <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">])</span>

<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span>
          <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
          <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span>
          <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
          <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">))</span>
<span class="n">score</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Test loss:&#39;</span><span class="p">,</span> <span class="n">score</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Test accuracy:&#39;</span><span class="p">,</span> <span class="n">score</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
<p>可使用如下命令拷贝到本地:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="o">-</span><span class="n">LO</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">raw</span><span class="o">.</span><span class="n">githubusercontent</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">keras</span><span class="o">-</span><span class="n">team</span><span class="o">/</span><span class="n">keras</span><span class="o">/</span><span class="n">master</span><span class="o">/</span><span class="n">examples</span><span class="o">/</span><span class="n">mnist_cnn</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
<p>并在最后加上如下一行代码:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;mnist_cnn.h5&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>在终端中执行mnist_cnn.py文件，如下:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="n">mnist_cnn</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">警告</p>
<p class="last">该过程需要连接网络获取mnist.npz文件（<a class="reference external" href="https://s3.amazonaws.com/img-datasets/mnist.npz">https://s3.amazonaws.com/img-datasets/mnist.npz</a>），会被保存到$HOME/.keras/datasets/。如果网络连接存在问题，可以通过其他方式获取mnist.npz后，直接保存到该目录即可。</p>
</div>
<p>执行过程会比较久，执行结束后，会产生在当前目录产生`mnist_cnn.h5`文件（HDF5格式），就是keras训练后模型，其中已经包含了训练后的模型结构和权重等信息。</p>
<p>该模型可以在服务器端，可以直接通过keras.models.load_model(“mnist_cnn.h5”)加载，然后进行推理；在移动设备需要将HDF5模型文件转换为TensorFlow Lite的格式，然后提供相应平台提供的Interpreter加载，然后进行推理。</p>
</div>
<div class="section" id="tensorflow-serving">
<h2>服务器部署模型：TensorFlow Serving<a class="headerlink" href="#tensorflow-serving" title="永久链接至标题">¶</a></h2>
</div>
<div class="section" id="tensorflow-lite">
<h2>移动/嵌入式端部署模型：TensorFlow Lite<a class="headerlink" href="#tensorflow-lite" title="永久链接至标题">¶</a></h2>
<div class="section" id="id1">
<h3>模型转换<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h3>
<p>使用TensorFlow训练好的模型，因为模型太大、运行效率比较低，不能直接在移动端部署，需要通过工具转化为Flat Buffer格式的模型。</p>
<p>谷歌提供了多种转换方式：</p>
<ul class="simple">
<li>tflight_convert：&gt;= TensorFlow 1.9</li>
<li>TOCO：&gt;= TensorFlow 1.7</li>
<li>通过代码转换</li>
</ul>
<p>我们使用最新的tflight_convert，其实在通过pip安装TensorFlow时一起安装，可以直接使用。</p>
<p>在终端执行如下命令:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tflight_convert</span> <span class="o">-</span><span class="n">h</span>
</pre></div>
</div>
<p>输出结果如下，即该命令的使用方法:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">usage</span><span class="p">:</span> <span class="n">tflite_convert</span> <span class="p">[</span><span class="o">-</span><span class="n">h</span><span class="p">]</span> <span class="o">--</span><span class="n">output_file</span> <span class="n">OUTPUT_FILE</span>
                      <span class="p">(</span><span class="o">--</span><span class="n">graph_def_file</span> <span class="n">GRAPH_DEF_FILE</span> <span class="o">|</span> <span class="o">--</span><span class="n">saved_model_dir</span> <span class="n">SAVED_MODEL_DIR</span> <span class="o">|</span> <span class="o">--</span><span class="n">keras_model_file</span> <span class="n">KERAS_MODEL_FILE</span><span class="p">)</span>
                      <span class="p">[</span><span class="o">--</span><span class="n">output_format</span> <span class="p">{</span><span class="n">TFLITE</span><span class="p">,</span><span class="n">GRAPHVIZ_DOT</span><span class="p">}]</span>
                      <span class="p">[</span><span class="o">--</span><span class="n">inference_type</span> <span class="p">{</span><span class="n">FLOAT</span><span class="p">,</span><span class="n">QUANTIZED_UINT8</span><span class="p">}]</span>
                      <span class="p">[</span><span class="o">--</span><span class="n">inference_input_type</span> <span class="p">{</span><span class="n">FLOAT</span><span class="p">,</span><span class="n">QUANTIZED_UINT8</span><span class="p">}]</span>
                      <span class="p">[</span><span class="o">--</span><span class="n">input_arrays</span> <span class="n">INPUT_ARRAYS</span><span class="p">]</span>
                      <span class="p">[</span><span class="o">--</span><span class="n">input_shapes</span> <span class="n">INPUT_SHAPES</span><span class="p">]</span>
                      <span class="p">[</span><span class="o">--</span><span class="n">output_arrays</span> <span class="n">OUTPUT_ARRAYS</span><span class="p">]</span>
                      <span class="p">[</span><span class="o">--</span><span class="n">saved_model_tag_set</span> <span class="n">SAVED_MODEL_TAG_SET</span><span class="p">]</span>
                      <span class="p">[</span><span class="o">--</span><span class="n">saved_model_signature_key</span> <span class="n">SAVED_MODEL_SIGNATURE_KEY</span><span class="p">]</span>
                      <span class="p">[</span><span class="o">--</span><span class="n">std_dev_values</span> <span class="n">STD_DEV_VALUES</span><span class="p">]</span>
                      <span class="p">[</span><span class="o">--</span><span class="n">mean_values</span> <span class="n">MEAN_VALUES</span><span class="p">]</span>
                      <span class="p">[</span><span class="o">--</span><span class="n">default_ranges_min</span> <span class="n">DEFAULT_RANGES_MIN</span><span class="p">]</span>
                      <span class="p">[</span><span class="o">--</span><span class="n">default_ranges_max</span> <span class="n">DEFAULT_RANGES_MAX</span><span class="p">]</span>
                      <span class="p">[</span><span class="o">--</span><span class="n">post_training_quantize</span><span class="p">]</span> <span class="p">[</span><span class="o">--</span><span class="n">drop_control_dependency</span><span class="p">]</span>
                      <span class="p">[</span><span class="o">--</span><span class="n">reorder_across_fake_quant</span><span class="p">]</span>
                      <span class="p">[</span><span class="o">--</span><span class="n">change_concat_input_ranges</span> <span class="p">{</span><span class="n">TRUE</span><span class="p">,</span><span class="n">FALSE</span><span class="p">}]</span>
                      <span class="p">[</span><span class="o">--</span><span class="n">allow_custom_ops</span><span class="p">]</span> <span class="p">[</span><span class="o">--</span><span class="n">target_ops</span> <span class="n">TARGET_OPS</span><span class="p">]</span>
                      <span class="p">[</span><span class="o">--</span><span class="n">dump_graphviz_dir</span> <span class="n">DUMP_GRAPHVIZ_DIR</span><span class="p">]</span>
                      <span class="p">[</span><span class="o">--</span><span class="n">dump_graphviz_video</span><span class="p">]</span>
</pre></div>
</div>
<p>模型的导出：Keras Sequential save方法中产生的模型文件，可以使用如下命令处理:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tflite_convert</span> <span class="o">--</span><span class="n">keras_model_file</span><span class="o">=./</span><span class="n">mnist_cnn</span><span class="o">.</span><span class="n">h5</span> <span class="o">--</span><span class="n">output_file</span><span class="o">=./</span><span class="n">mnist_cnn</span><span class="o">.</span><span class="n">tflite</span>
</pre></div>
</div>
<p>到此，我们已经得到一个可以运行的TensorFlow Lite模型了，即`mnist_cnn.tflite`。</p>
<div class="admonition warning">
<p class="first admonition-title">警告</p>
<p class="last">这里只介绍了keras HDF5格式模型的转换，其他模型转换建议参考：<a class="reference external" href="https://github.com/tensorflow/tensorflow/blob/master/tensorflow/lite/g3doc/convert/cmdline_examples.md">https://github.com/tensorflow/tensorflow/blob/master/tensorflow/lite/g3doc/convert/cmdline_examples.md</a></p>
</div>
</div>
<div class="section" id="android">
<h3>Android部署<a class="headerlink" href="#android" title="永久链接至标题">¶</a></h3>
<p>现在开始在Android环境部署，对于国内的读者，需要先给Android Studio配置proxy，因为gradle编译环境需要获取相应的资源，请大家自行解决，这里不再赘述。</p>
<p><strong>配置app/build.gradle</strong></p>
<p>新建一个Android Project，打开app/build.gradle添加如下信息:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">android</span> <span class="p">{</span>
    <span class="n">aaptOptions</span> <span class="p">{</span>
        <span class="n">noCompress</span> <span class="s2">&quot;tflite&quot;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="n">repositories</span> <span class="p">{</span>
    <span class="n">maven</span> <span class="p">{</span>
        <span class="n">url</span> <span class="s1">&#39;https://google.bintray.com/tensorflow&#39;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="n">dependencies</span> <span class="p">{</span>
    <span class="n">implementation</span> <span class="s1">&#39;org.tensorflow:tensorflow-lite:+&#39;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>其中，</p>
<p>1、aaptOptions设置tflite文件不压缩，确保后面tflite文件可以被Interpreter正确加载。
2、org.tensorflow:tensorflow-lite的最新版本号
注: 可以在这里查询https://bintray.com/google/tensorflow/tensorflow-lite</p>
<p>设置好后，sync和build整个工程，如果build成功说明，配置成功。</p>
<p><strong>添加tflite文件到assets文件夹</strong></p>
<p>在app目录先新建assets目录，并将`mnist_cnn.tflite`文件保存到assets目录。重新编译apk，检查新编译出来的apk的assets文件夹是否有`mnist_cnn.tflite`文件。</p>
<p>使用apk analyzer查看新编译出来的apk，存在如下目录即编译打包成功:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">assets</span>
     <span class="o">|</span><span class="n">__mnist_cnn</span><span class="o">.</span><span class="n">tflite</span>
</pre></div>
</div>
<p><strong>加载模型</strong></p>
<p>使用如下函数将`mnist_cnn.tflite`文件加载到memory-map中，作为Interpreter实例化的输入:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">private</span> <span class="n">static</span> <span class="n">final</span> <span class="n">String</span> <span class="n">MODEL_PATH</span> <span class="o">=</span> <span class="s2">&quot;mnist_cnn.tflite&quot;</span><span class="p">;</span>

<span class="o">/**</span> <span class="n">Memory</span><span class="o">-</span><span class="nb">map</span> <span class="n">the</span> <span class="n">model</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">Assets</span><span class="o">.</span> <span class="o">*/</span>
<span class="n">private</span> <span class="n">MappedByteBuffer</span> <span class="n">loadModelFile</span><span class="p">(</span><span class="n">Activity</span> <span class="n">activity</span><span class="p">)</span> <span class="n">throws</span> <span class="n">IOException</span> <span class="p">{</span>
    <span class="n">AssetFileDescriptor</span> <span class="n">fileDescriptor</span> <span class="o">=</span> <span class="n">activity</span><span class="o">.</span><span class="n">getAssets</span><span class="p">()</span><span class="o">.</span><span class="n">openFd</span><span class="p">(</span><span class="n">MODEL_PATH</span><span class="p">);</span>
    <span class="n">FileInputStream</span> <span class="n">inputStream</span> <span class="o">=</span> <span class="n">new</span> <span class="n">FileInputStream</span><span class="p">(</span><span class="n">fileDescriptor</span><span class="o">.</span><span class="n">getFileDescriptor</span><span class="p">());</span>
    <span class="n">FileChannel</span> <span class="n">fileChannel</span> <span class="o">=</span> <span class="n">inputStream</span><span class="o">.</span><span class="n">getChannel</span><span class="p">();</span>
    <span class="n">long</span> <span class="n">startOffset</span> <span class="o">=</span> <span class="n">fileDescriptor</span><span class="o">.</span><span class="n">getStartOffset</span><span class="p">();</span>
    <span class="n">long</span> <span class="n">declaredLength</span> <span class="o">=</span> <span class="n">fileDescriptor</span><span class="o">.</span><span class="n">getDeclaredLength</span><span class="p">();</span>
    <span class="k">return</span> <span class="n">fileChannel</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">FileChannel</span><span class="o">.</span><span class="n">MapMode</span><span class="o">.</span><span class="n">READ_ONLY</span><span class="p">,</span> <span class="n">startOffset</span><span class="p">,</span> <span class="n">declaredLength</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>实例化Interpreter，其中this为当前acitivity:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tflite</span> <span class="o">=</span> <span class="n">new</span> <span class="n">Interpreter</span><span class="p">(</span><span class="n">loadModelFile</span><span class="p">(</span><span class="n">this</span><span class="p">));</span>
</pre></div>
</div>
<p><strong>运行输入</strong></p>
<p>我们使用mnist test测试集中的某张图片作为输入，mnist图像大小28*28，单像素。这样我们输入的数据需要设置成如下格式:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/**</span> <span class="n">A</span> <span class="n">ByteBuffer</span> <span class="n">to</span> <span class="n">hold</span> <span class="n">image</span> <span class="n">data</span><span class="p">,</span> <span class="n">to</span> <span class="n">be</span> <span class="n">feed</span> <span class="n">into</span> <span class="n">Tensorflow</span> <span class="n">Lite</span> <span class="k">as</span> <span class="n">inputs</span><span class="o">.</span> <span class="o">*/</span>
<span class="n">private</span> <span class="n">ByteBuffer</span> <span class="n">imgData</span> <span class="o">=</span> <span class="n">null</span><span class="p">;</span>

<span class="n">private</span> <span class="n">static</span> <span class="n">final</span> <span class="nb">int</span> <span class="n">DIM_BATCH_SIZE</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">private</span> <span class="n">static</span> <span class="n">final</span> <span class="nb">int</span> <span class="n">DIM_PIXEL_SIZE</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="n">private</span> <span class="n">static</span> <span class="n">final</span> <span class="nb">int</span> <span class="n">DIM_IMG_WIDTH</span> <span class="o">=</span> <span class="mi">28</span><span class="p">;</span>
<span class="n">private</span> <span class="n">static</span> <span class="n">final</span> <span class="nb">int</span> <span class="n">DIM_IMG_HEIGHT</span> <span class="o">=</span> <span class="mi">28</span><span class="p">;</span>

<span class="n">protected</span> <span class="n">void</span> <span class="n">onCreate</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">imgData</span> <span class="o">=</span> <span class="n">ByteBuffer</span><span class="o">.</span><span class="n">allocateDirect</span><span class="p">(</span>
        <span class="mi">4</span> <span class="o">*</span> <span class="n">DIM_BATCH_SIZE</span> <span class="o">*</span> <span class="n">DIM_IMG_WIDTH</span> <span class="o">*</span> <span class="n">DIM_IMG_HEIGHT</span> <span class="o">*</span> <span class="n">DIM_PIXEL_SIZE</span><span class="p">);</span>
    <span class="n">imgData</span><span class="o">.</span><span class="n">order</span><span class="p">(</span><span class="n">ByteOrder</span><span class="o">.</span><span class="n">nativeOrder</span><span class="p">());</span>
<span class="p">}</span>
</pre></div>
</div>
<p>将mnist图片转化成ByteBuffer，并保持到imgData中:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/**</span> <span class="n">Preallocated</span> <span class="n">buffers</span> <span class="k">for</span> <span class="n">storing</span> <span class="n">image</span> <span class="n">data</span> <span class="ow">in</span><span class="o">.</span> <span class="o">*/</span>
<span class="n">private</span> <span class="nb">int</span><span class="p">[]</span> <span class="n">intValues</span> <span class="o">=</span> <span class="n">new</span> <span class="nb">int</span><span class="p">[</span><span class="n">DIM_IMG_WIDTH</span> <span class="o">*</span> <span class="n">DIM_IMG_HEIGHT</span><span class="p">];</span>

<span class="o">/**</span> <span class="n">Writes</span> <span class="n">Image</span> <span class="n">data</span> <span class="n">into</span> <span class="n">a</span> <span class="p">{</span><span class="nd">@code</span> <span class="n">ByteBuffer</span><span class="p">}</span><span class="o">.</span> <span class="o">*/</span>
<span class="n">private</span> <span class="n">void</span> <span class="n">convertBitmapToByteBuffer</span><span class="p">(</span><span class="n">Bitmap</span> <span class="n">bitmap</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">imgData</span> <span class="o">==</span> <span class="n">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="o">//</span> <span class="n">Rewinds</span> <span class="n">this</span> <span class="n">buffer</span><span class="o">.</span> <span class="n">The</span> <span class="n">position</span> <span class="ow">is</span> <span class="nb">set</span> <span class="n">to</span> <span class="n">zero</span> <span class="ow">and</span> <span class="n">the</span> <span class="n">mark</span> <span class="ow">is</span> <span class="n">discarded</span><span class="o">.</span>
    <span class="n">imgData</span><span class="o">.</span><span class="n">rewind</span><span class="p">();</span>

    <span class="n">bitmap</span><span class="o">.</span><span class="n">getPixels</span><span class="p">(</span><span class="n">intValues</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">bitmap</span><span class="o">.</span><span class="n">getWidth</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">bitmap</span><span class="o">.</span><span class="n">getWidth</span><span class="p">(),</span> <span class="n">bitmap</span><span class="o">.</span><span class="n">getHeight</span><span class="p">());</span>
    <span class="o">//</span> <span class="n">Convert</span> <span class="n">the</span> <span class="n">image</span> <span class="n">to</span> <span class="n">floating</span> <span class="n">point</span><span class="o">.</span>
    <span class="nb">int</span> <span class="n">pixel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="nb">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">DIM_IMG_WIDTH</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="nb">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">DIM_IMG_HEIGHT</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">final</span> <span class="nb">int</span> <span class="n">val</span> <span class="o">=</span> <span class="n">intValues</span><span class="p">[</span><span class="n">pixel</span><span class="o">++</span><span class="p">];</span>
            <span class="n">imgData</span><span class="o">.</span><span class="n">putFloat</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>convertBitmapToByteBuffer的输出即为模型运行的输入。</p>
<p><strong>运行输出</strong></p>
<p>定义一个1*10的多维数组，因为我们只有1个batch和10个label（TODO：need double check），具体代码如下:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">private</span> <span class="nb">float</span><span class="p">[][]</span> <span class="n">labelProbArray</span> <span class="o">=</span> <span class="n">new</span> <span class="nb">float</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">10</span><span class="p">];</span>
</pre></div>
</div>
<p>运行结束后，每个二级元素都是一个label的概率。</p>
<p><strong>运行及结果处理</strong></p>
<p>开始运行模型，具体代码如下:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tflite</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">imgData</span><span class="p">,</span> <span class="n">labelProbArray</span><span class="p">);</span>
</pre></div>
</div>
<p>针对某个图片，运行后labelProbArray的内容如下，也就是各个label识别的概率:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">index</span> <span class="mi">0</span> <span class="n">prob</span> <span class="ow">is</span> <span class="mf">0.0</span>
<span class="n">index</span> <span class="mi">1</span> <span class="n">prob</span> <span class="ow">is</span> <span class="mf">0.0</span>
<span class="n">index</span> <span class="mi">2</span> <span class="n">prob</span> <span class="ow">is</span> <span class="mf">0.0</span>
<span class="n">index</span> <span class="mi">3</span> <span class="n">prob</span> <span class="ow">is</span> <span class="mf">1.0</span>
<span class="n">index</span> <span class="mi">4</span> <span class="n">prob</span> <span class="ow">is</span> <span class="mf">0.0</span>
<span class="n">index</span> <span class="mi">6</span> <span class="n">prob</span> <span class="ow">is</span> <span class="mf">0.0</span>
<span class="n">index</span> <span class="mi">7</span> <span class="n">prob</span> <span class="ow">is</span> <span class="mf">0.0</span>
<span class="n">index</span> <span class="mi">8</span> <span class="n">prob</span> <span class="ow">is</span> <span class="mf">0.0</span>
<span class="n">index</span> <span class="mi">9</span> <span class="n">prob</span> <span class="ow">is</span> <span class="mf">0.0</span>
</pre></div>
</div>
<p>接下来，我们要做的就是根据对这些概率进行排序，找出Top的label并界面呈现给用户.</p>
</div>
</div>
<div class="section" id="tensorflow-js">
<h2>网页端部署模型：TensorFlow.js<a class="headerlink" href="#tensorflow-js" title="永久链接至标题">¶</a></h2>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="training.html" class="btn btn-neutral float-right" title="TensorFlow大规模训练" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="extended.html" class="btn btn-neutral" title="TensorFlow持久化与可视化" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018-2019, Xihan Li（雪麒）

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
        <script type="text/javascript" src="../_static/translations.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    

  

  <script type="text/javascript" src="../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>