

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="zh-CN" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="zh-CN" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>TensorFlow in JavaScript（Huan） &mdash; 简单粗暴TensorFlow 2.0 0.4 alpha 文档</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/js/custom.js"></script>
        <script type="text/javascript" src="../../_static/translations.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/custom.css" type="text/css" />
    <link rel="index" title="索引" href="../../genindex.html" />
    <link rel="search" title="搜索" href="../../search.html" />
    <link rel="next" title="TensorFlow分布式训练" href="../appendix/distributed.html" />
    <link rel="prev" title="TensorFlow Lite（Jinpeng）" href="lite.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> 简单粗暴TensorFlow 2.0
          

          
          </a>

          
            
            
              <div class="version">
                0.4
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">目录</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../preface.html">前言</a></li>
<li class="toctree-l1"><a class="reference internal" href="../introduction.html">TensorFlow概述</a></li>
</ul>
<p class="caption"><span class="caption-text">基础</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../basic/installation.html">TensorFlow安装与环境配置</a></li>
<li class="toctree-l1"><a class="reference internal" href="../basic/basic.html">TensorFlow基础</a></li>
<li class="toctree-l1"><a class="reference internal" href="../basic/models.html">TensorFlow模型建立与训练</a></li>
<li class="toctree-l1"><a class="reference internal" href="../basic/tools.html">TensorFlow常用模块</a></li>
</ul>
<p class="caption"><span class="caption-text">部署</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="export.html">TensorFlow模型导出</a></li>
<li class="toctree-l1"><a class="reference internal" href="serving.html">TensorFlow Serving</a></li>
<li class="toctree-l1"><a class="reference internal" href="lite.html">TensorFlow Lite（Jinpeng）</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">TensorFlow in JavaScript（Huan）</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#tensorflow-js">Tensorflow.js 简介</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id1">在浏览器中使用 Tensorflow.js</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id2">一个浏览器中的基本的线性回归模型</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id3">在服务器端使用 Tensorflow.js</a></li>
<li class="toctree-l2"><a class="reference internal" href="#tensorflow-js-python">通过 Tensorflow.js 加载 Python 模型</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#tensorflow-jstensorflowjs-converter">Tensorflow.js转换器tensorflowjs_converter</a></li>
<li class="toctree-l3"><a class="reference internal" href="#savedmodel">转换 SavedModel</a></li>
<li class="toctree-l3"><a class="reference internal" href="#frozen-model">转换 Frozen Model</a></li>
<li class="toctree-l3"><a class="reference internal" href="#hub-model">转换 Hub Model</a></li>
<li class="toctree-l3"><a class="reference internal" href="#keras-model">转换 Keras Model</a></li>
<li class="toctree-l3"><a class="reference internal" href="#javascript">用JavaScript加载和运行</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id4">Tensorflow.js 性能对比</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#python">Python性能基准</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id5">浏览器性能</a></li>
<li class="toctree-l3"><a class="reference internal" href="#node-js">Node.js性能</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">大规模训练与加速</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../appendix/distributed.html">TensorFlow分布式训练</a></li>
<li class="toctree-l1"><a class="reference internal" href="../appendix/tpu.html">使用TPU训练TensorFlow模型（Huan）</a></li>
</ul>
<p class="caption"><span class="caption-text">扩展</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../appendix/tfhub.html">TensorFlow Hub 模型复用（Jinpeng）</a></li>
<li class="toctree-l1"><a class="reference internal" href="../appendix/tfds.html">TensorFlow Datasets 数据集载入</a></li>
<li class="toctree-l1"><a class="reference internal" href="../appendix/swift.html">TensorFlow in Swift（Huan）</a></li>
<li class="toctree-l1"><a class="reference internal" href="../appendix/julia.html">TensorFlow in Julia（Ziyang）</a></li>
</ul>
<p class="caption"><span class="caption-text">附录</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../appendix/static.html">图模型下的TensorFlow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../appendix/docker.html">使用Docker部署TensorFlow环境</a></li>
<li class="toctree-l1"><a class="reference internal" href="../appendix/cloud.html">在云端使用TensorFlow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../appendix/optimization.html">TensorFlow性能优化</a></li>
<li class="toctree-l1"><a class="reference internal" href="../appendix/recommended_books.html">参考资料与推荐阅读</a></li>
<li class="toctree-l1"><a class="reference internal" href="../appendix/terms.html">术语中英对照表</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">简单粗暴TensorFlow 2.0</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
      <li>TensorFlow in JavaScript（Huan）</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/zh/deployment/javascript.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="tensorflow-in-javascript-huan">
<h1>TensorFlow in JavaScript（Huan）<a class="headerlink" href="#tensorflow-in-javascript-huan" title="永久链接至标题">¶</a></h1>
<blockquote>
<div><p><strong>Atwood’s Law</strong></p>
<p>“Any application that can be written in JavaScript, will eventually be written in JavaScript.”</p>
<blockquote>
<div>– Jeff Atwood, Founder of StackOverflow.com</div></blockquote>
<p>“JavaScript now works.”</p>
<blockquote>
<div>– Paul Graham, YC Founder</div></blockquote>
</div></blockquote>
<div class="section" id="tensorflow-js">
<h2>Tensorflow.js 简介<a class="headerlink" href="#tensorflow-js" title="永久链接至标题">¶</a></h2>
<div class="figure align-center">
<a class="reference internal image-reference" href="../../_images/tensorflow-js.gif"><img alt="../../_images/tensorflow-js.gif" src="../../_images/tensorflow-js.gif" style="width: 60%;" /></a>
</div>
<p>Tensorflow.js 是 Tensorflow 的 JavaScript 版本，支持GPU硬件加速，可以运行在 Node.js 或浏览器环境中。它不但支持完全基于 JavaScript 从头开发、训练和部署模型，也可以用来运行已有的 Python 版 Tensorflow 模型，或者基于现有的模型进行继续训练。</p>
<div class="figure align-center">
<a class="reference internal image-reference" href="../../_images/architecture.gif"><img alt="../../_images/architecture.gif" src="../../_images/architecture.gif" style="width: 60%;" /></a>
</div>
<p>Tensorflow.js 支持 GPU 硬件加速。在 Node.js 环境中，如果有 CUDA 环境支持，或者在浏览器环境中，有 WebGL 环境支持，那么 Tensorflow.js 可以使用硬件进行加速。</p>
<p>本章，我们将基于 Tensorflow.js 1.0，向大家简单的介绍如何基于 ES6 的 JavaScript 进行 Tensorflow.js 的开发，然后提供两个例子，并基于例子进行详细的讲解和介绍，最终实现使用纯 JavaScript 进行 Tensorflow 模型的开发、训练和部署。</p>
<p>本章中提到的 JavaScript 版 Tensorflow 的相关代码，使用说明，和训练好的模型文件及参数，都可以在作者的 GitHub 上找到。地址： <a class="reference external" href="https://github.com/huan/javascript-concise-chitchat">https://github.com/huan/javascript-concise-chitchat</a></p>
</div>
<div class="section" id="id1">
<h2>在浏览器中使用 Tensorflow.js<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h2>
<div class="figure align-center">
<a class="reference internal image-reference" href="../../_images/chrome-ml.png"><img alt="../../_images/chrome-ml.png" src="../../_images/chrome-ml.png" style="width: 60%;" /></a>
</div>
<p>Tensorflow.js可以让我们直接在浏览器中加载Tensorflow，让用户立即通过本地的CPU/GPU资源进行我们所需要的机器学习运算，更灵活的进行AI应用的开发。</p>
<p>浏览器中进行机器学习，相对比与服务器端来讲，将拥有以下四大优势：</p>
<ul class="simple">
<li>不需要安装软件或驱动（打开浏览器即可使用）；</li>
<li>可以通过浏览器进行更加方便的人机交互；</li>
<li>可以通过手机浏览器，调用手机硬件的各种传感器（如：GPS、电子罗盘、加速度传感器、摄像头等）；</li>
<li>用户的数据可以无需上传到服务器，在本地即可完成所需操作。</li>
</ul>
<p>通过这些优势，Tensorflow.js 将带给开发者带来极高的灵活性。比如我们可以在手机上打开浏览器，通过手机摄像头检测视频中用户的身体动作姿势，然后通过对图片数据库中类似身体动作姿势的检索，给用户显示一个最能够和他当前动作相似的照片。这就是 Google Creative Lab 在2018年7月发布的 Move Mirror。在 Move Mirror 的运行过程中，数据没有上传到服务器，所有的运算都是在手机本地，基于手机的CPU/GPU完成的，而这项技术，将使Servreless与AI应用结合起来成为可能。</p>
<div class="figure align-center">
<a class="reference internal image-reference" href="../../_images/move-mirror.jpg"><img alt="../../_images/move-mirror.jpg" src="../../_images/move-mirror.jpg" style="width: 60%;" /></a>
</div>
<p>Move Mirror 所使用的 PoseNet 地址：<a class="reference external" href="https://github.com/tensorflow/tfjs-models/tree/master/posenet">https://github.com/tensorflow/tfjs-models/tree/master/posenet</a></p>
</div>
<div class="section" id="id2">
<h2>一个浏览器中的基本的线性回归模型<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h2>
<p>在 Tensorflow 基础章节中，我们已经用 Python 实现过，针对某城市在2013年-2017年的房价的任务，通过对该数据进行线性回归，即使用线性模型 <span class="math notranslate nohighlight">\(y = ax + b\)</span> 来拟合上述数据，此处 <span class="math notranslate nohighlight">\(a\)</span> 和 <span class="math notranslate nohighlight">\(b\)</span> 是待求的参数。</p>
<p>下面我们改用 Tensorflow.js 来实现一个 JavaScript 版本。</p>
<p>首先，我们定义数据，进行基本的归一化操作。</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kr">import</span> <span class="o">*</span> <span class="nx">as</span> <span class="nx">tf</span> <span class="nx">from</span> <span class="s1">&#39;@tensorflow/tfjs&#39;</span>

<span class="kr">const</span> <span class="nx">xsRaw</span> <span class="o">=</span> <span class="nx">tf</span><span class="p">.</span><span class="nx">tensor</span><span class="p">([</span><span class="mi">2013</span><span class="p">,</span> <span class="mi">2014</span><span class="p">,</span> <span class="mi">2015</span><span class="p">,</span> <span class="mi">2016</span><span class="p">,</span> <span class="mi">2017</span><span class="p">])</span>
<span class="kr">const</span> <span class="nx">ysRaw</span> <span class="o">=</span> <span class="nx">tf</span><span class="p">.</span><span class="nx">tensor</span><span class="p">([</span><span class="mi">12000</span><span class="p">,</span> <span class="mi">14000</span><span class="p">,</span> <span class="mi">15000</span><span class="p">,</span> <span class="mi">16500</span><span class="p">,</span> <span class="mi">17500</span><span class="p">])</span>

<span class="c1">// 归一化</span>
<span class="kr">const</span> <span class="nx">xs</span> <span class="o">=</span> <span class="nx">xsRaw</span><span class="p">.</span><span class="nx">sub</span><span class="p">(</span><span class="nx">xsRaw</span><span class="p">.</span><span class="nx">min</span><span class="p">())</span>
                <span class="p">.</span><span class="nx">div</span><span class="p">(</span><span class="nx">xsRaw</span><span class="p">.</span><span class="nx">max</span><span class="p">().</span><span class="nx">sub</span><span class="p">(</span><span class="nx">xsRaw</span><span class="p">.</span><span class="nx">min</span><span class="p">()))</span>
<span class="kr">const</span> <span class="nx">ys</span> <span class="o">=</span> <span class="nx">ysRaw</span><span class="p">.</span><span class="nx">sub</span><span class="p">(</span><span class="nx">ysRaw</span><span class="p">.</span><span class="nx">min</span><span class="p">())</span>
                <span class="p">.</span><span class="nx">div</span><span class="p">(</span><span class="nx">ysRaw</span><span class="p">.</span><span class="nx">max</span><span class="p">().</span><span class="nx">sub</span><span class="p">(</span><span class="nx">ysRaw</span><span class="p">.</span><span class="nx">min</span><span class="p">()))</span>
</pre></div>
</div>
<p>接下来，我们来求线性模型中两个参数 <code class="docutils literal notranslate"><span class="pre">a</span></code> 和 <code class="docutils literal notranslate"><span class="pre">b</span></code> 的值。</p>
<p>使用 <code class="docutils literal notranslate"><span class="pre">loss()</span></code> 计算损失；
使用 <code class="docutils literal notranslate"><span class="pre">optimizer.minimize()</span></code> 自动更新模型参数。</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kr">const</span> <span class="nx">a</span> <span class="o">=</span> <span class="nx">tf</span><span class="p">.</span><span class="nx">scalar</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()).</span><span class="nx">variable</span><span class="p">()</span>
<span class="kr">const</span> <span class="nx">b</span> <span class="o">=</span> <span class="nx">tf</span><span class="p">.</span><span class="nx">scalar</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()).</span><span class="nx">variable</span><span class="p">()</span>

<span class="c1">// y = a * x + b.</span>
<span class="kr">const</span> <span class="nx">f</span> <span class="o">=</span> <span class="p">(</span><span class="nx">x</span><span class="o">:</span> <span class="nx">tf</span><span class="p">.</span><span class="nx">Tensor</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">a</span><span class="p">.</span><span class="nx">mul</span><span class="p">(</span><span class="nx">x</span><span class="p">).</span><span class="nx">add</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">loss</span> <span class="o">=</span> <span class="p">(</span><span class="nx">pred</span><span class="o">:</span> <span class="nx">tf</span><span class="p">.</span><span class="nx">Tensor</span><span class="p">,</span> <span class="nx">label</span><span class="o">:</span> <span class="nx">tf</span><span class="p">.</span><span class="nx">Tensor</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">pred</span><span class="p">.</span><span class="nx">sub</span><span class="p">(</span><span class="nx">label</span><span class="p">).</span><span class="nx">square</span><span class="p">().</span><span class="nx">mean</span><span class="p">()</span> <span class="nx">as</span> <span class="nx">tf</span><span class="p">.</span><span class="nx">Scalar</span>

<span class="kr">const</span> <span class="nx">learningRate</span> <span class="o">=</span> <span class="mi">1</span><span class="nx">e</span><span class="o">-</span><span class="mi">3</span>
<span class="kr">const</span> <span class="nx">optimizer</span> <span class="o">=</span> <span class="nx">tf</span><span class="p">.</span><span class="nx">train</span><span class="p">.</span><span class="nx">sgd</span><span class="p">(</span><span class="nx">learningRate</span><span class="p">)</span>

<span class="c1">// 训练模型</span>
<span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">10000</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
   <span class="nx">optimizer</span><span class="p">.</span><span class="nx">minimize</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">loss</span><span class="p">(</span><span class="nx">f</span><span class="p">(</span><span class="nx">xs</span><span class="p">),</span> <span class="nx">ys</span><span class="p">))</span>
<span class="p">}</span>

<span class="c1">// 预测</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`a: </span><span class="si">${</span><span class="nx">a</span><span class="p">.</span><span class="nx">dataSync</span><span class="p">()</span><span class="si">}</span><span class="sb">, b: </span><span class="si">${</span><span class="nx">b</span><span class="p">.</span><span class="nx">dataSync</span><span class="p">()</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="kr">const</span> <span class="nx">preds</span> <span class="o">=</span> <span class="nx">f</span><span class="p">(</span><span class="nx">xs</span><span class="p">).</span><span class="nx">dataSync</span><span class="p">()</span> <span class="nx">as</span> <span class="nx">Float32Array</span>
<span class="kr">const</span> <span class="nx">trues</span> <span class="o">=</span> <span class="nx">ys</span><span class="p">.</span><span class="nx">arraySync</span><span class="p">()</span> <span class="nx">as</span> <span class="nx">number</span><span class="p">[]</span>
<span class="nx">preds</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">pred</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
   <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`x: </span><span class="si">${</span><span class="nx">i</span><span class="si">}</span><span class="sb">, pred: </span><span class="si">${</span><span class="nx">pred</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="sb">, true: </span><span class="si">${</span><span class="nx">trues</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="p">})</span>
</pre></div>
</div>
<p>从下面的输出样例中我们可以看到，已经拟合的比较接近了。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">a</span><span class="p">:</span> <span class="mf">0.9339302778244019</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="mf">0.08108722418546677</span>
<span class="n">x</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pred</span><span class="p">:</span> <span class="mf">0.08</span><span class="p">,</span> <span class="n">true</span><span class="p">:</span> <span class="mf">0.00</span>
<span class="n">x</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="n">pred</span><span class="p">:</span> <span class="mf">0.31</span><span class="p">,</span> <span class="n">true</span><span class="p">:</span> <span class="mf">0.36</span>
<span class="n">x</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="n">pred</span><span class="p">:</span> <span class="mf">0.55</span><span class="p">,</span> <span class="n">true</span><span class="p">:</span> <span class="mf">0.55</span>
<span class="n">x</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="n">pred</span><span class="p">:</span> <span class="mf">0.78</span><span class="p">,</span> <span class="n">true</span><span class="p">:</span> <span class="mf">0.82</span>
<span class="n">x</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="n">pred</span><span class="p">:</span> <span class="mf">1.02</span><span class="p">,</span> <span class="n">true</span><span class="p">:</span> <span class="mf">1.00</span>
</pre></div>
</div>
<p>可以直接在浏览器中运行，完整的 HTML 代码如下：</p>
<div class="highlight-html notranslate"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;http://unpkg.com/@tensorflow/tfjs/dist/tf.min.js&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span>
      <span class="kr">const</span> <span class="nx">xsRaw</span> <span class="o">=</span> <span class="nx">tf</span><span class="p">.</span><span class="nx">tensor</span><span class="p">([</span><span class="mi">2013</span><span class="p">,</span> <span class="mi">2014</span><span class="p">,</span> <span class="mi">2015</span><span class="p">,</span> <span class="mi">2016</span><span class="p">,</span> <span class="mi">2017</span><span class="p">])</span>
      <span class="kr">const</span> <span class="nx">ysRaw</span> <span class="o">=</span> <span class="nx">tf</span><span class="p">.</span><span class="nx">tensor</span><span class="p">([</span><span class="mi">12000</span><span class="p">,</span> <span class="mi">14000</span><span class="p">,</span> <span class="mi">15000</span><span class="p">,</span> <span class="mi">16500</span><span class="p">,</span> <span class="mi">17500</span><span class="p">])</span>

      <span class="c1">// 归一化</span>
      <span class="kr">const</span> <span class="nx">xs</span> <span class="o">=</span> <span class="nx">xsRaw</span><span class="p">.</span><span class="nx">sub</span><span class="p">(</span><span class="nx">xsRaw</span><span class="p">.</span><span class="nx">min</span><span class="p">())</span>
                      <span class="p">.</span><span class="nx">div</span><span class="p">(</span><span class="nx">xsRaw</span><span class="p">.</span><span class="nx">max</span><span class="p">().</span><span class="nx">sub</span><span class="p">(</span><span class="nx">xsRaw</span><span class="p">.</span><span class="nx">min</span><span class="p">()))</span>
      <span class="kr">const</span> <span class="nx">ys</span> <span class="o">=</span> <span class="nx">ysRaw</span><span class="p">.</span><span class="nx">sub</span><span class="p">(</span><span class="nx">ysRaw</span><span class="p">.</span><span class="nx">min</span><span class="p">())</span>
                      <span class="p">.</span><span class="nx">div</span><span class="p">(</span><span class="nx">ysRaw</span><span class="p">.</span><span class="nx">max</span><span class="p">().</span><span class="nx">sub</span><span class="p">(</span><span class="nx">ysRaw</span><span class="p">.</span><span class="nx">min</span><span class="p">()))</span>
      <span class="kr">const</span> <span class="nx">a</span> <span class="o">=</span> <span class="nx">tf</span><span class="p">.</span><span class="nx">scalar</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()).</span><span class="nx">variable</span><span class="p">()</span>
      <span class="kr">const</span> <span class="nx">b</span> <span class="o">=</span> <span class="nx">tf</span><span class="p">.</span><span class="nx">scalar</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()).</span><span class="nx">variable</span><span class="p">()</span>

      <span class="c1">// y = a * x + b.</span>
      <span class="kr">const</span> <span class="nx">f</span> <span class="o">=</span> <span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">a</span><span class="p">.</span><span class="nx">mul</span><span class="p">(</span><span class="nx">x</span><span class="p">).</span><span class="nx">add</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span>
      <span class="kr">const</span> <span class="nx">loss</span> <span class="o">=</span> <span class="p">(</span><span class="nx">pred</span><span class="p">,</span> <span class="nx">label</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">pred</span><span class="p">.</span><span class="nx">sub</span><span class="p">(</span><span class="nx">label</span><span class="p">).</span><span class="nx">square</span><span class="p">().</span><span class="nx">mean</span><span class="p">()</span>

      <span class="kr">const</span> <span class="nx">learningRate</span> <span class="o">=</span> <span class="mi">1</span><span class="nx">e</span><span class="o">-</span><span class="mi">3</span>
      <span class="kr">const</span> <span class="nx">optimizer</span> <span class="o">=</span> <span class="nx">tf</span><span class="p">.</span><span class="nx">train</span><span class="p">.</span><span class="nx">sgd</span><span class="p">(</span><span class="nx">learningRate</span><span class="p">)</span>

      <span class="c1">// 训练模型</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">10000</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">optimizer</span><span class="p">.</span><span class="nx">minimize</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">loss</span><span class="p">(</span><span class="nx">f</span><span class="p">(</span><span class="nx">xs</span><span class="p">),</span> <span class="nx">ys</span><span class="p">))</span>
      <span class="p">}</span>

      <span class="c1">// 预测</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`a: </span><span class="si">${</span><span class="nx">a</span><span class="p">.</span><span class="nx">dataSync</span><span class="p">()</span><span class="si">}</span><span class="sb">, b: </span><span class="si">${</span><span class="nx">b</span><span class="p">.</span><span class="nx">dataSync</span><span class="p">()</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
      <span class="kr">const</span> <span class="nx">preds</span> <span class="o">=</span> <span class="nx">f</span><span class="p">(</span><span class="nx">xs</span><span class="p">).</span><span class="nx">dataSync</span><span class="p">()</span>
      <span class="kr">const</span> <span class="nx">trues</span> <span class="o">=</span> <span class="nx">ys</span><span class="p">.</span><span class="nx">arraySync</span><span class="p">()</span>
      <span class="nx">preds</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">pred</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
         <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`x: </span><span class="si">${</span><span class="nx">i</span><span class="si">}</span><span class="sb">, pred: </span><span class="si">${</span><span class="nx">pred</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="sb">, true: </span><span class="si">${</span><span class="nx">trues</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
      <span class="p">})</span>
    <span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="id3">
<h2>在服务器端使用 Tensorflow.js<a class="headerlink" href="#id3" title="永久链接至标题">¶</a></h2>
<p>服务器端使用 JavaScript ，首先需要按照 <a class="reference external" href="https://nodejs.org">NodeJS.org</a> 官网的说明，完成安装最新版本的 Node.js 。</p>
<p>然后，完成以下四个步骤即可完成配置：</p>
<ol class="arabic">
<li><p class="first">确认 Node.js 版本:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ node --verion
v10.5.0

$ npm --version
6.4.1
</pre></div>
</div>
</li>
<li><p class="first">建立 Tensorflow.js 项目目录:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ mkdir tfjs
$ cd tfjs
</pre></div>
</div>
</li>
<li><p class="first">安装 Tensorflow.js:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># 初始化项目管理文件 package.json
$ npm init -y

# 安装 tfjs 库，纯 JavaScript 版本
$ npm install @tensorflow/tfjs

# 安装 tfjs-node 库，C Binding 版本
$ npm install @tensorflow/tfjs-node

# 安装 tfjs-node-gpu 库，支持 CUDA GPU 加速
$ npm install @tensorflow/tfjs-node-gpu
</pre></div>
</div>
</li>
<li><p class="first">确认 Node.js 和 Tensorflow.js 工作正常:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ node
&gt; require(&#39;@tensorflow/tfjs&#39;).version
{ &#39;tfjs-core&#39;: &#39;1.0.1&#39;,
  &#39;tfjs-data&#39;: &#39;1.0.1&#39;,
  &#39;tfjs-layers&#39;: &#39;1.0.1&#39;,
  &#39;tfjs-converter&#39;: &#39;1.0.1&#39;,
  tfjs: &#39;1.0.1&#39; }
&gt;
</pre></div>
</div>
</li>
</ol>
<p>如果你看到了上面的 <code class="docutils literal notranslate"><span class="pre">tfjs-core</span></code>, <code class="docutils literal notranslate"><span class="pre">tfjs-data</span></code>, <code class="docutils literal notranslate"><span class="pre">tfjs-layers</span></code> 和 <code class="docutils literal notranslate"><span class="pre">tfjs-converter</span></code> 的输出信息，那么就说明环境配置没有问题了。</p>
</div>
<div class="section" id="tensorflow-js-python">
<h2>通过 Tensorflow.js 加载 Python 模型<a class="headerlink" href="#tensorflow-js-python" title="永久链接至标题">¶</a></h2>
<p>一般Tensorflow的模型，以Python版本为例，会被存储为以下四种格式之一：</p>
<ul class="simple">
<li>TensorFlow SavedModel</li>
<li>Frozen Model</li>
<li>Tensorflow Hub Module</li>
<li>Keras Module</li>
</ul>
<p>所有以上四种格式，都可以通过 tensorflowjs-converter 转换器，将其转换为可以直接被 Tensorflow.js 加载的格式，在JavaScript语言中进行使用。</p>
<div class="section" id="tensorflow-jstensorflowjs-converter">
<h3>Tensorflow.js转换器tensorflowjs_converter<a class="headerlink" href="#tensorflow-jstensorflowjs-converter" title="永久链接至标题">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">tensorflowjs_converter</span></code> 可以将Python存储的模型格式，转换为JavaScript可以直接调用的模型格式。</p>
<p>安装 <code class="docutils literal notranslate"><span class="pre">tensorflowjs_converter</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ pip install tensorflowjs
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">tensorflowjs_converter</span></code> 的使用细节，可以通过 <code class="docutils literal notranslate"><span class="pre">--help</span></code> 参数查看程序帮助:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ tensorflowjs_converter --help
</pre></div>
</div>
<p>以下我们以MobilenetV1为例，看一下如何对模型文件进行转换操作，并将可以被Tensorflow.js加载的模型文件，存放到 <code class="docutils literal notranslate"><span class="pre">/mobilenet/tfjs_model</span></code> 目录下。</p>
</div>
<div class="section" id="savedmodel">
<h3>转换 SavedModel<a class="headerlink" href="#savedmodel" title="永久链接至标题">¶</a></h3>
<p>将 <code class="docutils literal notranslate"><span class="pre">/mobilenet/saved_model</span></code> 转换到 <code class="docutils literal notranslate"><span class="pre">/mobilenet/tfjs_model</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tensorflowjs_converter</span> \
    <span class="o">--</span><span class="n">input_format</span><span class="o">=</span><span class="n">tf_saved_model</span> \
    <span class="o">--</span><span class="n">output_node_names</span><span class="o">=</span><span class="s1">&#39;MobilenetV1/Predictions/Reshape_1&#39;</span> \
    <span class="o">--</span><span class="n">saved_model_tags</span><span class="o">=</span><span class="n">serve</span> \
    <span class="o">/</span><span class="n">mobilenet</span><span class="o">/</span><span class="n">saved_model</span> \
    <span class="o">/</span><span class="n">mobilenet</span><span class="o">/</span><span class="n">tfjs_model</span>
</pre></div>
</div>
</div>
<div class="section" id="frozen-model">
<h3>转换 Frozen Model<a class="headerlink" href="#frozen-model" title="永久链接至标题">¶</a></h3>
<p>将 <code class="docutils literal notranslate"><span class="pre">/mobilenet/frozen_model.pb</span></code> 转换到 <code class="docutils literal notranslate"><span class="pre">/mobilenet/tfjs_model</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tensorflowjs_converter</span> \
    <span class="o">--</span><span class="n">input_format</span><span class="o">=</span><span class="n">tf_frozen_model</span> \
    <span class="o">--</span><span class="n">output_node_names</span><span class="o">=</span><span class="s1">&#39;MobilenetV1/Predictions/Reshape_1&#39;</span> \
    <span class="o">/</span><span class="n">mobilenet</span><span class="o">/</span><span class="n">frozen_model</span><span class="o">.</span><span class="n">pb</span> \
    <span class="o">/</span><span class="n">mobilenet</span><span class="o">/</span><span class="n">tfjs_model</span>
</pre></div>
</div>
</div>
<div class="section" id="hub-model">
<h3>转换 Hub Model<a class="headerlink" href="#hub-model" title="永久链接至标题">¶</a></h3>
<p>将 <code class="docutils literal notranslate"><span class="pre">https://tfhub.dev/google/imagenet/mobilenet_v1_100_224/classification/1</span></code> 转换到 <code class="docutils literal notranslate"><span class="pre">/mobilenet/tfjs_model</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tensorflowjs_converter</span> \
    <span class="o">--</span><span class="n">input_format</span><span class="o">=</span><span class="n">tf_hub</span> \
    <span class="s1">&#39;https://tfhub.dev/google/imagenet/mobilenet_v1_100_224/classification/1&#39;</span> \
    <span class="o">/</span><span class="n">mobilenet</span><span class="o">/</span><span class="n">tfjs_model</span>
</pre></div>
</div>
</div>
<div class="section" id="keras-model">
<h3>转换 Keras Model<a class="headerlink" href="#keras-model" title="永久链接至标题">¶</a></h3>
<p>将 <code class="docutils literal notranslate"><span class="pre">/tmp/model.h5</span></code> 转换到 <code class="docutils literal notranslate"><span class="pre">/tmp/tfjs_model</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ tensorflowjs_converter \
    --input_format keras \
    /tmp/model.h5 \
    /tmp/tfjs_model
</pre></div>
</div>
</div>
<div class="section" id="javascript">
<h3>用JavaScript加载和运行<a class="headerlink" href="#javascript" title="永久链接至标题">¶</a></h3>
<p>为了加载转换完成的模型文件，我们需要安装 <code class="docutils literal notranslate"><span class="pre">tfjs-converter</span></code> 和 <code class="docutils literal notranslate"><span class="pre">&#64;tensorflow/tfjs</span></code> 模块:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ npm install @tensorflow/tfjs
</pre></div>
</div>
<p>然后，我们就可以通过JavaScript来加载Tensorflow模型了！</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kr">import</span> <span class="o">*</span> <span class="nx">as</span> <span class="nx">tf</span> <span class="nx">from</span> <span class="s1">&#39;@tensorflow/tfjs&#39;</span><span class="p">;</span>

<span class="kr">const</span> <span class="nx">MODEL_URL</span> <span class="o">=</span> <span class="s1">&#39;model_directory/model.json&#39;</span><span class="p">;</span>

<span class="kr">const</span> <span class="nx">model</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">tf</span><span class="p">.</span><span class="nx">loadGraphModel</span><span class="p">(</span><span class="nx">MODEL_URL</span><span class="p">);</span>
<span class="c1">// 对Keras或者tfjs原生的层模型，使用下面的加载函数:</span>
<span class="c1">// const model = await tf.loadLayersModel(MODEL_URL);</span>

<span class="kr">const</span> <span class="nx">cat</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;cat&#39;</span><span class="p">);</span>
<span class="nx">model</span><span class="p">.</span><span class="nx">execute</span><span class="p">(</span><span class="nx">tf</span><span class="p">.</span><span class="nx">browser</span><span class="p">.</span><span class="nx">fromPixels</span><span class="p">(</span><span class="nx">cat</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="id4">
<h2>Tensorflow.js 性能对比<a class="headerlink" href="#id4" title="永久链接至标题">¶</a></h2>
<p>Tensorflow.js的性能如何，Google官方做了一份基于 MobileNet 的评测，可以作为参考。具体评测是基于 MobileNet 的 Tensorflow 模型，将其 JavaScript 版本和 Python 版本各运行两百次。</p>
<p>其评测结论如下。</p>
<div class="section" id="python">
<h3>Python性能基准<a class="headerlink" href="#python" title="永久链接至标题">¶</a></h3>
<p>Python代码运行一次推理：</p>
<ul class="simple">
<li>在CPU上需要时间为56.6ms</li>
<li>在GPU上需要时间为2.82ms</li>
</ul>
<p>我们将Python代码运行所需要的时间，设为基准1。</p>
</div>
<div class="section" id="id5">
<h3>浏览器性能<a class="headerlink" href="#id5" title="永久链接至标题">¶</a></h3>
<p>在浏览器中，Tensorflow.js 可以使用 WebGL 进行硬件加速，将 GPU 资源使用起来。</p>
<div class="figure align-center">
<a class="reference internal image-reference" href="../../_images/performance-browser.gif"><img alt="../../_images/performance-browser.gif" src="../../_images/performance-browser.gif" style="width: 60%;" /></a>
</div>
<p>Tensorflow.js在浏览器中运行一次推理：</p>
<ul class="simple">
<li>在CPU上需要时间为97.3ms</li>
<li>在GPU (WebGL)上需要时间为10.8ms</li>
</ul>
<p>与Python代码基准相比，浏览器中的 Tensorflow.js 在 CPU 上的运行时间为基准的1.7倍，在 GPU (WebGL) 上运行的时间为基准的3.8倍。</p>
</div>
<div class="section" id="node-js">
<h3>Node.js性能<a class="headerlink" href="#node-js" title="永久链接至标题">¶</a></h3>
<p>在 Node.js 中，Tensorflow.js 使用 Tensorflow 的 C Binding ，所以基本上可以达到和 Python 接近的效果。</p>
<div class="figure align-center">
<a class="reference internal image-reference" href="../../_images/performance-node.gif"><img alt="../../_images/performance-node.gif" src="../../_images/performance-node.gif" style="width: 60%;" /></a>
</div>
<p>Tensorflow.js 在 Node.js 运行一次推理：</p>
<ul class="simple">
<li>在 CPU 上需要时间为56.23ms</li>
<li>在 GPU (CUDA) 上需要时间为3.12ms</li>
</ul>
<p>与 Python 代码基准相比，Node.js 的 Tensorflow.js 在 CPU 上的运行时间与基准相同，在 GPU (CUDA) 上运行的时间是基准的1.1倍。</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../appendix/distributed.html" class="btn btn-neutral float-right" title="TensorFlow分布式训练" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="lite.html" class="btn btn-neutral float-left" title="TensorFlow Lite（Jinpeng）" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018-2019, Xihan Li（雪麒）

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>